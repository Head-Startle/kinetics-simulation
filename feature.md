## 代码功能与运行逻辑

### 📋 整体功能

这是一个**化学动力学模拟器**，读取 YAML 控制文件描述化学反应体系，用显式欧拉法求解浓度随时间变化，生成 CSV 数据并提供交互式可视化界面。

> 注意：本项目不再提供作为包的模块化导入入口（即不再支持 `import kns` 或 `python -m kns`），仅保留命令行入口 `kns`。请先通过 `pip install -e .` 安装开发可执行命令，然后使用 `kns` 运行模拟或 `kns --plot <csv>` 绘图。

---

### 🔧 核心函数模块

#### **1. 反应式解析器**

```python
parse_term()    # 解析单个项，如 "2.5B(1.5)" → (名称B, 系数2.5, 级数1.5)
parse_side()    # 解析一侧反应物/产物，返回化学计量数字典和级数字典
parse_reaction()# 解析完整反应式，支持 "--", "->", "⇌" 三种箭头
```

**功能**：将文本反应式转换为可计算的数据结构，支持：

- 化学计量数（如 `2A`）
- 自定义反应级数（如 `B(2)` 表示速率用 [B]²，但物质变化量按系数 1 计算）

#### **2. 速率计算**

```python
rate_from_side(conc_map, stoich_dict, order_dict)
```

**功能**：计算一侧的速率因子，公式为 $\prod [X_i]^{n_i}$

- 优先使用 `order_dict` 中的反应级数
- 若未指定级数则使用化学计量数（质量作用定律）
- 特殊处理 $0^0 = 1$

#### **3. 模拟引擎**

```python
simulate(control)
```

**核心逻辑**：

1. **物质初始化**：解析 species 列表，建立名称/别名→索引的映射
2. **反应解析**：验证物质存在性，计算化学计量向量 $\mathbf{s}$（产物系数 - 反应物系数）
3. **时间积分**（显式欧拉法）：
   ```
   每步循环：
     构建浓度映射表 conc_map
     对每个反应：
       r_f = kf × 正向速率因子
       r_b = kb × 逆向速率因子
       net = r_f - r_b
       dcdt += s × net
     更新浓度：conc = conc + dt × dcdt
     防止负浓度：conc[conc < 0] = 0
   ```
4. **输出 CSV**：保存 `time, species1, species2, ...` 格式的数据

#### **4. 交互式绘图**

```python
interactive_plot(times, data, species, title, outdir)
```

**特性**：

- **预创建 artist**：避免重复创建/销毁图形对象，提升滑块响应速度
- **滑块控制**：拖动查看任意时刻的浓度
- **播放/倒放按钮**：自动循环播放
- **动画循环**：用 `FuncAnimation` 驱动，30ms 刷新间隔
- **窗口标题**：使用 control 文件的 `title` 或输出文件名
- **保存功能**：工具栏保存按钮默认打开 `pic/` 目录

---

### ⚙️ 执行流程

```
启动 main()
  ↓
创建 dat/ 和 pic/ 目录
  ↓
判断模式：
  ├─ --plot 模式：直接加载 CSV → 跳到绘图
  └─ 模拟模式：
       ↓
     读取控制文件 (control.yaml)
       ↓
     自动添加 .csv 扩展名（如果缺失）
       ↓
     调用 simulate()
       ├─ 解析物质和反应
       ├─ 显式欧拉积分
       └─ 写 CSV 到 dat/
       ↓
     提取 title（control['title'] 或 output 文件名）
       ↓
     调用 interactive_plot()
       ├─ 设置保存路径到 pic/
       ├─ 预创建曲线和标记
       ├─ 绑定滑块/按钮事件
       └─ 启动 matplotlib 窗口
```

---

### 🎯 关键特性

| 特性           | 实现方式                                                           |
| -------------- | ------------------------------------------------------------------ |
| **别名支持**   | `name_to_idx_map` 存储所有名称和别名到索引的映射                   |
| **非基元反应** | `order_dict` 与 `stoich_dict` 分离，级数用于速率，系数用于物质变化 |
| **性能优化**   | 预创建 Line2D/marker，滑块只更新数据不重绘坐标轴                   |
| **容错设计**   | 冲突级数警告、负浓度截断、0^0 特殊处理                             |
| **灵活输出**   | 自动补全 .csv 扩展名，title 可选默认用文件名                       |

---

### 📊 数据流示意

```
control.yaml → simulate() → CSV (dat/)
                    ↓
              times, data, species
                    ↓
           interactive_plot() → 窗口显示 + 可保存 PNG (pic/)
```

关键：**化学计量数控制物质消耗/生成量，反应级数控制速率表达式**，二者独立可配。
